<!DOCTYPE html>

<html lang="ru">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>–ö–µ—à–∞ –∏ –ö–µ–∫—Å —Å–Ω–∏–º–∞—é—Ç —Å—Ç—Ä–µ—Å—Å!</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Use the UMD build of Supabase v2 so window.supabase is available in WebView -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body.has-modal {
            overflow: hidden;
        }



        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 5000;
        }



        .modal.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }



        .modal-content {
            width: 100%;
            max-width: 320px;
            padding: 28px 24px 24px;
            border-radius: 20px;
            background: rgba(16, 16, 32, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
            color: #ffffff;
            text-align: center;
        }



        .modal-content p {
            margin: 0 0 20px;
            font-size: 16px;
            line-height: 1.4;
        }

        .modal-content h2 {
            margin: 0 0 20px 0;
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* –í–∫–ª–∞–¥–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ */
        .leaderboard-tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
            margin: 0 0 12px 0;
            padding: 6px;
            border-radius: 12px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.10);
        }
        .leaderboard-tab {
            flex: 1;
            min-height: 36px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid transparent;
            background: transparent;
            color: #e0e0e0;
            font-weight: 600;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .leaderboard-tab.is-active {
            color: #ffffff;
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.18);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.12);
        }

        #leaderboardList {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }

        #leaderboardList li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            font-size: 15px;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        #leaderboardList li:last-child {
            border-bottom: none;
        }



        .primary-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            padding: 0 24px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(22, 33, 62, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }



        .primary-btn--full {

            width: 100%;

        }



        .primary-btn:active {
            transform: scale(0.96) translateY(1px);
            background: linear-gradient(135deg, #0f0f1a 0%, #0d1525 50%, #0a1d3a 100%);
            box-shadow: 0 2px 6px rgba(22, 33, 62, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        .primary-btn:hover {
            box-shadow: 0 6px 16px rgba(22, 33, 62, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        :root {

            /* –ù–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞–Ω–∏–º–∞—Ü–∏–π (6 —Å–µ–∫—É–Ω–¥) */

            --celebration-duration: 6s;

        }



        body {

            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;

            text-align: center;

            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);

            color: #e0e0e0;

            padding: 0;

            margin: 0;

            min-height: 100vh;

            position: relative;

            overflow: hidden;

            touch-action: manipulation;

        }



        /* --- –ù–û–í–´–ï –ë–õ–û–ö–ò –î–õ–Ø –í–ï–†–•–ê –°–¢–†–ê–ù–ò–¶–´ --- */

        .achievements-bar {
            position: fixed;
            top: calc(env(safe-area-inset-top, 20px) + 90px);
            left: 0;
            right: 0;
            padding-top: 8px;
            padding-bottom: 8px;
            z-index: 1000;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }



        .achievement-grid {
            flex: none;
            display: grid;
            grid-template-columns: repeat(6, minmax(0, 1fr)); /* –≤—Å–µ–≥–¥–∞ 6 –∫–æ–ª–æ–Ω–æ–∫ ‚Üí 2 —Å—Ç—Ä–æ–∫–∏ */
            gap: 4px;
            padding: 0 12px;
            max-width: 100%;
            width: 100%;
            pointer-events: auto;
            transform: scale(var(--ach-scale, 1));
            transform-origin: top center;
        }



        .achievement-slot {
            min-height: 24px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #f1f1f1;
            font-size: 9px;
            overflow: hidden;
            transition: all 0.2s;
            cursor: pointer;
            gap: 3px;
            padding: 0 4px;
            white-space: nowrap;
        }
        



        .achievement-slot span:first-child {
            font-size: 11px;
        }



        .achievement-slot span:last-child {

            font-weight: 600;

            letter-spacing: 0.5px;

        }





        .achievement-slot.unlocked {
            background: linear-gradient(135deg, rgba(22, 33, 62, 0.8) 0%, rgba(15, 52, 96, 0.9) 100%);
            color: #ffffff;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(22, 33, 62, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
        }



        /* --- –°–î–í–ò–ì –ö–û–ù–¢–ï–ù–¢–ê –í–ù–ò–ó --- */

        .content-wrapper {
            /* –û–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∏–∂–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ –∞—á–∏–≤–æ–∫ (2 —Ä—è–¥–∞) */
            padding-top: calc(env(safe-area-inset-top, 20px) + 200px);
            /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –±–µ–∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
            padding-bottom: 160px;
            max-width: 90%;
            margin: 0 auto;
        }



        /* --- –ù–û–í–ê–Ø –ë–û–õ–¨–®–ê–Ø –ö–ù–û–ü–ö–ê (TAP ZONE) --- */

        .tap-zone {
            /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è */
            display: block;
            position: fixed;
            left: 16px;
            right: 16px;
            bottom: 64px;
            height: 280px;

            /* Apple glass ‚Äî –ª—ë–≥–∫–∏–π, —Å –æ—Ç—Ç–µ–Ω–∫–æ–º —Ü–≤–µ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
            background:
                linear-gradient(180deg, rgba(22,33,62,0.26) 0%, rgba(22,33,62,0.10) 100%),
                radial-gradient(120% 100% at 50% 0%, rgba(255,255,255,0.16) 0%, rgba(255,255,255,0.05) 45%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(160, 180, 240, 0.20);
            border-radius: 24px;
            backdrop-filter: blur(22px) saturate(140%);
            -webkit-backdrop-filter: blur(22px) saturate(140%);

            cursor: pointer;
            z-index: 10;
            margin: 0;
            padding: 0;

            transform-style: preserve-3d;
            transition: transform 260ms cubic-bezier(0.22, 1, 0.36, 1), box-shadow 320ms cubic-bezier(0.22, 1, 0.36, 1), background 480ms ease;
            box-shadow: 0 8px 22px rgba(0,0,0,0.16), inset 0 1px 0 rgba(255,255,255,0.14);
        }
        .tap-zone:active {
            transform: translateY(0.5px) scale(0.996);
            box-shadow: 0 6px 16px rgba(0,0,0,0.14), inset 0 1px 0 rgba(255,255,255,0.18);
        }

        /* –í–∏–∑—É–∞–ª—å–Ω–∞—è —Ä–∞–º–∫–∞ –¥–ª—è –∑–æ–Ω—ã —Ç–∞–ø–∞ */
        .tap-zone::before {
            /* –¢–æ–Ω–∫–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∫–∞–π–º–∞ –∏ –≤–µ—Ä—Ö–Ω–∏–π –±–ª–∏–∫–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            content: "";
            position: absolute;
            inset: 8px;
            border-radius: 20px;
            border: 1px solid rgba(200,210,255,0.22);
            background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.05));
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.18);
            opacity: 0.9;
            pointer-events: none;
        }
        .tap-zone::after {
            /* –ï–¥–≤–∞ –∑–∞–º–µ—Ç–Ω—ã–π ¬´—à–∏–º–µ—Ä¬ª */
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 24px;
            background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.16) 45%, rgba(255,255,255,0.26) 50%, rgba(255,255,255,0.16) 55%, transparent 100%);
            background-size: 220% 100%;
            animation: shimmer 6s ease-in-out infinite;
            mix-blend-mode: screen;
            pointer-events: none;
        }
        .tap-zone.tap-tilt-left  { transform: perspective(800px) rotateY(2deg) translateZ(0); }
        .tap-zone.tap-tilt-right { transform: perspective(800px) rotateY(-2deg) translateZ(0); }



        /* --- –°–¢–ò–õ–ò –û–°–¢–ê–õ–ò–°–¨ –í –û–°–ù–û–í–ù–û–ú –¢–ï –ñ–ï, –ù–û –ù–ï–ú–ù–û–ì–û –û–ß–ò–©–ï–ù–´ --- */



        .cat-container {

            display: flex;

            justify-content: space-around;

            margin: 20px 0;

            gap: 20px;

            position: relative;

            z-index: 20; /* –ö–æ—Ç–∏–∫–∏ –Ω–∞–¥ —Ç–∞—á-–∑–æ–Ω–æ–π */

        }



        .cat {

            width: var(--cat-size, 150px);

            height: var(--cat-size, 150px);

            cursor: pointer;

            border-radius: 20px;

            transition: transform 0.2s ease, box-shadow 0.2s ease;

            box-shadow: 0 4px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);

            border: 1px solid rgba(255,255,255,0.1);

            touch-action: manipulation;

        }



        .cat:active {

            transform: scale(0.98);

        }



        h1 {
            color: #ffffff;
            font-size: 24px;
            font-weight: 700;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: -0.5px;
            margin: 0 0 10px 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 0 20px rgba(255,255,255,0.1);
        }



        p {
            color: #d0d0d0;
            font-size: 15px;
            font-weight: 400;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: 0.2px;
            line-height: 1.5;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        
        /* –ü–æ–¥–ø–∏—Å—å –±–µ–∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞ ‚Äî –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ –≤–∫–ª—é—á—ë–Ω */
        p.subtitle-one {
            margin-top: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
            max-width: 100%;
        }

        #score {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: 0.3px;
            margin: 15px 0;
            text-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }



        /* –ê—á–∏–≤–∫–∞-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞, –Ω–æ —Å –Ω–æ–≤—ã–º —Ç–µ–∫—Å—Ç–æ–º) */

        .achievement {
            position: fixed;
            top: calc(env(safe-area-inset-top, 20px) + 45px);
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            color: #ffffff;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            display: none;
            pointer-events: none;
        }

        .achievement.show {
            opacity: 1;
            display: block;
            animation: bounceUp 0.5s ease;
            transform: translateX(-50%) translateY(0);
        }





        /* –ê–Ω–∏–º–∞—Ü–∏—è –º–∏–≥–∞–Ω–∏—è –¥–ª—è —Å—É–ø–µ—Ä-—ç—Ñ—Ñ–µ–∫—Ç–∞ */

        /* –£–í–ï–õ–ò–ß–ï–ù–û –ö–û–õ–ò–ß–ï–°–¢–í–û –ú–ò–ì–ê–ù–ò–ô */

        @keyframes flash-strong {

            0%, 100% { opacity: 1; }

            50% { opacity: 0.2; }

        }



        /* –£–í–ï–õ–ò–ß–ï–ù–ê –ö–û–ù–¢–†–ê–°–¢–ù–û–°–¢–¨ –¶–í–ï–¢–û–í –ú–ò–ì–ê–ù–ò–Ø */

        @keyframes blink-strong {

            0%, 100% { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%); }

            50% { background: linear-gradient(135deg, #FFD700 0%, #FF69B4 50%, #00FFFF 100%); }

        }

        

        /* –ü—Ä–æ—á–∏–µ —Å—Ç–∏–ª–∏... */

        .heart {

            position: absolute;

            font-size: 24px;

            color: #ff69b4;

            pointer-events: none;

            z-index: 100;

            animation: floatUp 1s ease-out forwards;

            transform-origin: center;

        }

        .celebration-particle {

             animation-duration: var(--celebration-duration);

        }

        @keyframes floatUp {

            0% {

                opacity: 1;

                transform: translateY(0) translateX(0) rotate(0deg) scale(1);

            }

            100% {

                opacity: 0;

                transform: translateY(-120px) translateX(var(--rand-x, 0px)) rotate(360deg) scale(0.5);

            }

        }

        @keyframes bounceUp {

            0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
            40% { transform: translateX(-50%) translateY(10px); }
            60% { transform: translateX(-50%) translateY(5px); }
        }

        @keyframes shimmer {
            0%   { background-position: 200% 0; opacity: 0.00; }
            10%  { opacity: 0.12; }
            50%  { background-position: -20% 0; opacity: 0.22; }
            90%  { opacity: 0.10; }
            100% { background-position: -20% 0; opacity: 0.00; }
        }
            60% { transform: translateX(-50%) translateY(5px); }

        }



    </style>

</head>

<body>

    <div class="achievements-bar">

        <div class="achievement-grid" id="achievementGrid">

            <!-- –ü–µ—Ä–≤—ã–π —Ä—è–¥ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π -->
            <div id="ach-slot-100" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>üêæ</span><span>100</span></div>
            <div id="ach-slot-200" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>‚ú®</span><span>200</span></div>
            <div id="ach-slot-500" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>üåü</span><span>500</span></div>
            <div id="ach-slot-1k" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>üòª</span><span>1K</span></div>
            <div id="ach-slot-2k" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>üíñ</span><span>2K</span></div>
            <div id="ach-slot-5k" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>üéâ</span><span>5K</span></div>

            <!-- –í—Ç–æ—Ä–æ–π —Ä—è–¥ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π -->
            <div id="ach-slot-10k" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>üéØ</span><span>10K</span></div>
            <div id="ach-slot-20k" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>‚≠ê</span><span>20K</span></div>
            <div id="ach-slot-50k" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>üíé</span><span>50K</span></div>
            <div id="ach-slot-100k" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>üëë</span><span>100K</span></div>
            <div id="ach-slot-500k" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>üèÜ</span><span>500K</span></div>
            <div id="ach-slot-1m" class="achievement-slot" onclick="alert('–ï—â—ë –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!')"><span>üåü</span><span>1M</span></div>

        </div>

    </div>



    <div id="welcomeModalFirst" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-content">
            <p>–ü—Ä–∏–≤–µ—Ç, –ù–∏–∫—á—ë–º–Ω–∏, –≤–∫—É—Å–Ω–∏ –ø—Ä–∏–Ω—ë—Å–±?! üòª</p>
            <p>–î–∞–≤–∞–π –≤–∫—É—Å–Ω–∏, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∏ –≤—Ö–æ–¥–∏.</p>
            <input id="firstNameInput" type="text" maxlength="15" placeholder="–ù–∏–∫–Ω–µ–π–º (4‚Äì15 —Å–∏–º–≤–æ–ª–æ–≤)" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);color:#fff;outline:none;">
            <div id="firstNameError" style="color:#ff6b6b;font-size:12px;margin-top:6px;min-height:16px;"></div>
            <div style="height:8px"></div>
            <button class="primary-btn primary-btn--full" onclick="saveFirstTimeName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="welcomeModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-content">
            <p>–ü—Ä–∏–≤–µ—Ç, –ù–∏–∫—á—ë–º–Ω–∏, –≤–∫—É—Å–Ω–∏ –ø—Ä–∏–Ω—ë—Å–±?! üòª</p>
            <button class="primary-btn primary-btn--full" onclick="closeModal()">–ù–∞—á–∞—Ç—å —Ç–µ—Ä–∞–ø–∏—é!</button>
        </div>
    </div>



    <div id="leaderboardModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">

        <div class="modal-content">

            <h2>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>

            <div class="leaderboard-tabs" role="tablist" aria-label="Leaderboard Tabs">
                <button class="leaderboard-tab is-active" id="tabTotal" data-tab="total" role="tab" aria-selected="true">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</button>
                <button class="leaderboard-tab" id="tabRun" data-tab="run" role="tab" aria-selected="false">–ó–∞ –æ–¥–∏–Ω –∑–∞—Ö–æ–¥</button>
            </div>

            <ul id="leaderboardList"></ul>

            <div style="text-align:left;margin:10px 0 14px 0; display:flex; align-items:center; gap:10px;">
                <label style="display:flex; align-items:center; gap:8px; color:#e0e0e0; font-size:14px;">
                    <input type="checkbox" id="lightModeToggle" /> –õ—ë–≥–∫–∏–π —Ä–µ–∂–∏–º (–º–µ–Ω—å—à–µ –∞–Ω–∏–º–∞—Ü–∏–π)
                </label>
            </div>

            <button class="primary-btn primary-btn--full" onclick="document.getElementById('leaderboardModal').classList.remove('show'); document.body.classList.remove('has-modal');">–ó–∞–∫—Ä—ã—Ç—å</button>

        </div>

    </div>




    <div class="content-wrapper">

        <h1>–ö–µ—à–∞ –∏ –ö–µ–∫—Å —Å–Ω–∏–º–∞—é—Ç —Å—Ç—Ä–µ—Å—Å!‚ù§Ô∏è</h1>

        <div class="cat-container" id="catContainer">

            <img id="cat1" class="cat cat1" src="https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2550.jpeg" alt="–ö–µ—à–∞ (—à–æ–∫–æ–ª–∞–¥–Ω—ã–π –∫–æ—Ç–∏–∫)">

            <img id="cat2" class="cat cat2" src="https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2558.jpeg" alt="–ö–µ–∫—Å (—Å–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π –∫–æ—Ç–∏–∫)">

        </div>

        <div id="score">–û—á–∫–∏ —É—é—Ç–∞: 0</div>

        <button class="primary-btn" onclick="showLeaderboard()">üèÜ –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ø</button>

        <p class="subtitle-one">–ö–æ—Ç–∏–∫–∏ –º—É—Ä–ª—ã—á—É—Ç –≤ —É–Ω–∏—Å–æ–Ω! –ì–ª–∞–¥—å –∫–æ—Ç–∏–∫–æ–≤! üòª</p>

    </div>



    <button id="tapZone" class="tap-zone" aria-label="–ë–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è —Ç–∞–ø–æ–≤"></button>



    <div id="achievement" class="achievement">

        <span id="ach-text"></span> üèÜ

    </div>

    <!-- Debug Console (hidden) -->
    <div id="debugConsole" style="position:fixed;bottom:60px;left:10px;right:10px;max-height:200px;background:rgba(0,0,0,0.9);color:#0f0;font-family:monospace;font-size:10px;padding:10px;border-radius:8px;overflow-y:auto;z-index:9999;display:none;pointer-events:none;visibility:hidden;">
        <button onclick="document.getElementById('debugConsole').style.display='none'" style="position:absolute;top:5px;right:5px;background:#f00;color:#fff;border:none;border-radius:4px;padding:2px 6px;cursor:pointer;">‚úï</button>
        <div id="debugLog"></div>
    </div>
    <button onclick="document.getElementById('debugConsole').style.display='block'" style="position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,0.7);color:#0f0;border:2px solid #0f0;border-radius:50%;width:50px;height:50px;font-size:20px;cursor:pointer;z-index:9998;display:none;pointer-events:none;visibility:hidden;">üêõ</button>



    <audio id="backgroundMusic" loop preload="auto">
        <source src="mur.mp3" type="audio/mpeg">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
    </audio>



    <script>

        const tg = window.Telegram.WebApp;

        tg.ready();

        tg.expand();

        // Debug logger
        function debugLog(msg) {
            const log = document.getElementById('debugLog');
            if (log) {
                const time = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                entry.textContent = `[${time}] ${msg}`;
                entry.style.marginBottom = '4px';
                entry.style.borderBottom = '1px solid #333';
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 100 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                if (log.children.length > 100) log.removeChild(log.firstChild);
            }
            console.log(msg);
        }

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥ –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–π –º–æ–¥–∞–ª–∫–∏
        let inputLocked = true;

        debugLog('App started');

        document.addEventListener('DOMContentLoaded', () => {
            debugLog('DOM loaded');
            debugLog(`Telegram user: ${tg.initDataUnsafe?.user?.id || 'NONE'}`);
            debugLog(`initData present: ${!!tg.initData}`);
            try { decideWelcomeModal(); } catch (_) {}
            try { loadServerProgress().then(() => { try { restoreAchievementGridFromScore(); } catch(_){} }); } catch (_) {}
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        // –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Supabase –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏:
        // 1. –î–ª—è —á—Ç–µ–Ω–∏—è (SELECT): —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ–º (anon) —á–∏—Ç–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É leaderboard
        // 2. –î–ª—è –∑–∞–ø–∏—Å–∏ (INSERT/UPDATE): —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ–º (anon) –ø–∏—Å–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É leaderboard
        // –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Ä–≤–∏—Å–Ω—É—é —Ä–æ–ª—å –¥–ª—è –∑–∞–ø–∏—Å–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
        let supabaseClient = null;
        try {
            const supabaseUrl = 'https://aduxktmwnrilsbpydhye.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdXhrdG13bnJpbHNicHlkaHllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODc2MzYsImV4cCI6MjA3ODM2MzYzNn0.MBj-HLDcqu2PHkbJp7ZfvWf2GsX_83-ZFny3YI5uRbU';
            
            debugLog('Supabase init started');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Supabase SDK
            if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                debugLog('Supabase client created');
                
                // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                supabaseClient.from('leaderboard').select('count', { count: 'exact', head: true })
                    .then(({ count, error }) => {
                        if (error) {
                            console.warn('[Supabase Init] –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è (–≤–æ–∑–º–æ–∂–Ω–æ, RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç):', error);
                        } else {
                            console.log('[Supabase Init] –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ:', count);
                        }
                    })
                    .catch(err => {
                        console.warn('[Supabase Init] –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:', err);
                    });
            } else {
                console.warn('[Supabase Init] Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                console.warn('[Supabase Init] –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
            }
        } catch (error) {
            console.error('[Supabase Init] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', error);
            console.error('[Supabase Init] Stack trace:', error.stack);
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å Supabase
        // Helpers for username management and RPC fallback
        function getStoredDisplayName() {
            try { return localStorage.getItem('kk_display_name') || ''; } catch (_) { return ''; }
        }
        function setStoredDisplayName(name) {
            try { localStorage.setItem('kk_display_name', name); } catch (_) {}
        }
        function getEffectiveUsername(defaultUsername) {
            const saved = (getStoredDisplayName() || '').trim();
            return saved || (defaultUsername || '–ê–Ω–æ–Ω–∏–º');
        }

        // –õ—ë–≥–∫–∏–π —Ä–µ–∂–∏–º (–∞–Ω–∏–º–∞—Ü–∏–∏)
        function getLightMode() {
            try {
                const v = localStorage.getItem('kk_light_mode');
                if (v === '1') return true;
                if (v === '0') return false;
            } catch (_) {}
            // –ê–≤—Ç–æ: —É–≤–∞–∂–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π reduced motion
            try {
                return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            } catch (_) { return false; }
        }
        function setLightMode(on) {
            try { localStorage.setItem('kk_light_mode', on ? '1' : '0'); } catch (_) {}
        }
        function getCelebrationDurationMs() { return getLightMode() ? 2500 : 6000; }

        async function updateScore(telegramId, username, newScore) {
            if (!supabaseClient) {
                console.warn('[updateScore] Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }

            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ telegramId - —á–∏—Å–ª–æ (Telegram –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ)
            const userId = typeof telegramId === 'string' ? parseInt(telegramId, 10) : telegramId;
            
            console.log('[updateScore] –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', { userId, username, newScore });

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—á—ë—Ç
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('max_score')
                    .eq('telegram_id', userId)
                    .maybeSingle();

                if (error) {
                    console.warn('[updateScore] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ max_score (maybeSingle):', error);
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: –µ—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–∞, –ø–æ–ø—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏
                }

                const currentMax = (data && typeof data.max_score === 'number') ? data.max_score : 0;
                console.log('[updateScore] –¢–µ–∫—É—â–∏–π –º–∞–∫—Å–∏–º—É–º:', currentMax, '–ù–æ–≤—ã–π —Å—á—ë—Ç:', newScore);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–æ–≤—ã–π —Å—á—ë—Ç –±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ –º–∞–∫—Å–∏–º—É–º–∞
                if (newScore > currentMax) {
                    const effectiveUsername = getEffectiveUsername(username);
                    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∞—Ç–æ–º–∞—Ä–Ω—ã–π RPC set_max_score (–µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ –ë–î)
                    try {
                        const { error: rpcError } = await supabaseClient.rpc('set_max_score', {
                            p_telegram_id: userId,
                            p_username: effectiveUsername,
                            p_new_score: newScore
                        });
                        if (!rpcError) {
                            console.log('[updateScore] RPC set_max_score: —É—Å–ø–µ—Ö');
                            return;
                        } else {
                            console.warn('[updateScore] RPC set_max_score: –æ—à–∏–±–∫–∞, fallback –Ω–∞ upsert', rpcError);
                        }
                    } catch (e) {
                        console.warn('[updateScore] RPC –≤—ã–∑–æ–≤ –Ω–µ —É–¥–∞–ª—Å—è, fallback –Ω–∞ upsert', e);
                    }

                    const recordData = {
                        telegram_id: userId,
                        username: effectiveUsername,
                        max_score: newScore,
                        updated_at: new Date().toISOString()
                    };
                    
                    console.log('[updateScore] –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è upsert:', recordData);
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º upsert —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –¥–∞–Ω–Ω—ã—Ö
                    const { data: upsertData, error: upsertError } = await supabaseClient
                        .from('leaderboard')
                        .upsert(recordData, { onConflict: 'telegram_id' })
                        .select();

                    if (upsertError) {
                        console.error('[updateScore] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç–∞:', upsertError);
                        console.error('[updateScore] –ö–æ–¥ –æ—à–∏–±–∫–∏:', upsertError.code);
                        console.error('[updateScore] –°–æ–æ–±—â–µ–Ω–∏–µ:', upsertError.message);
                        console.error('[updateScore] –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', JSON.stringify(upsertError, null, 2));
                        
                        // –ü–æ–ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - —Å–Ω–∞—á–∞–ª–∞ insert, –ø–æ—Ç–æ–º update –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        if (upsertError.code === '42501' || upsertError.message?.includes('permission')) {
                            console.warn('[updateScore] –ü–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É —Å RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Supabase.');
                        }
                    } else {
                        console.log('[updateScore] –°—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω:', upsertData);
                        if (upsertData && upsertData.length > 0) {
                            console.log('[updateScore] –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å:', upsertData[0]);
                        }
                    }
                } else {
                    console.log('[updateScore] –ù–æ–≤—ã–π —Å—á—ë—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è');
                }
            } catch (error) {
                console.error('[updateScore] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
                console.error('[updateScore] Stack trace:', error.stack);
            }
        }

        async function getLeaderboardTopRun() {
            if (!supabaseClient) { console.warn('[getLeaderboardTopRun] Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); return []; }
            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('username, max_score, telegram_id')
                    .order('max_score', { ascending: false })
                    .limit(10);
                if (error) { console.error('[getLeaderboardTopRun] error', error); return []; }
                return data || [];
            } catch (e) { console.error('[getLeaderboardTopRun] catch', e); return []; }
        }
        async function getLeaderboardTopTotal() {
            if (!supabaseClient) { console.warn('[getLeaderboardTopTotal] Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); return []; }
            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('username, total_score, telegram_id')
                    .order('total_score', { ascending: false })
                    .limit(10);
                if (error) { console.error('[getLeaderboardTopTotal] error', error); return []; }
                return data || [];
            } catch (e) { console.error('[getLeaderboardTopTotal] catch', e); return []; }
        }

        async function showLeaderboard() {
            console.log('[showLeaderboard] –û—Ç–∫—Ä—ã—Ç–∏–µ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞');
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—á—ë—Ç –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
            const user = tg.initDataUnsafe?.user;
            if (user && supabaseClient && score > 0) {
                debugLog('[showLeaderboard] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º...');
                // –û—Ç–º–µ–Ω—è–µ–º debounce
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                    saveTimeout = null;
                }
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –∂–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                try {
                    await updateScores(user.id, user.username || 'anon', runScore, score);
                    // –ñ–¥—ë–º –µ—â—ë 50ms —á—Ç–æ–±—ã –ë–î —Ç–æ—á–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å
                    await new Promise(resolve => setTimeout(resolve, 50));
                } catch (e) {
                    console.error('[showLeaderboard] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
                }
            }
            
            try {
                const leaderboardModal = document.getElementById('leaderboardModal');
                const leaderboardList = document.getElementById('leaderboardList');
                const tabRun = document.getElementById('tabRun');
                const tabTotal = document.getElementById('tabTotal');
                if (!leaderboardModal || !leaderboardList || !tabRun || !tabTotal) {
                    console.error('[showLeaderboard] –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    return;
                }
                const setActive = (mode) => {
                    if (mode === 'run') {
                        tabRun.classList.add('is-active'); tabRun.setAttribute('aria-selected','true');
                        tabTotal.classList.remove('is-active'); tabTotal.setAttribute('aria-selected','false');
                    } else {
                        tabTotal.classList.add('is-active'); tabTotal.setAttribute('aria-selected','true');
                        tabRun.classList.remove('is-active'); tabRun.setAttribute('aria-selected','false');
                    }
                };
                const render = (data, mode) => {
                    leaderboardList.innerHTML = '';
                    if (!data || data.length === 0) {
                        const li = document.createElement('li');
                        li.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤';
                        li.style.color = '#b0b0b0';
                        li.style.textAlign = 'center';
                        li.style.padding = '20px 0';
                        leaderboardList.appendChild(li);
                        return;
                    }
                    data.forEach((item, index) => {
                        const li = document.createElement('li');
                        if (mode === 'run') {
                            li.textContent = `${index + 1}. ${item.username || '–ê–Ω–æ–Ω–∏–º'} ‚Äî ${item.max_score} –æ—á–∫–æ–≤ –∑–∞ –∑–∞—Ö–æ–¥`;
                        } else {
                            li.textContent = `${index + 1}. ${item.username || '–ê–Ω–æ–Ω–∏–º'} ‚Äî ${item.total_score} –≤—Å–µ–≥–æ`;
                        }
                        leaderboardList.appendChild(li);
                    });
                };

                leaderboardList.innerHTML = '<li style="color: #b0b0b0;">–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
                leaderboardModal.classList.add('show');
                leaderboardModal.setAttribute('aria-hidden', 'false');
                document.body.classList.add('has-modal');

                // –õ—ë–≥–∫–∏–π —Ä–µ–∂–∏–º —á–µ–∫–±–æ–∫—Å
                const chk = document.getElementById('lightModeToggle');
                if (chk) { chk.checked = !!getLightMode(); chk.onchange = () => setLightMode(chk.checked); }

                // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫ (–æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ)
                tabRun.onclick = async () => {
                    setActive('run');
                    leaderboardList.innerHTML = '<li style="color: #b0b0b0;">–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
                    const data = await getLeaderboardTopRun();
                    render(data, 'run');
                };
                tabTotal.onclick = async () => {
                    setActive('total');
                    leaderboardList.innerHTML = '<li style="color: #b0b0b0;">–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
                    const data = await getLeaderboardTopTotal();
                    render(data, 'total');
                };

                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ¬´–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è¬ª
                setActive('total');
                const data = await getLeaderboardTopTotal();
                render(data, 'total');
            } catch (error) {
                console.error('[showLeaderboard] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞:', error);
                const leaderboardList = document.getElementById('leaderboardList');
                if (leaderboardList) {
                    leaderboardList.innerHTML = '<li style="color: #ff6b6b; text-align: center; padding: 20px 0;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</li>';
                }
            }
        }

        // –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏)
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: testLeaderboard()
        window.testLeaderboard = async function() {
            console.log('[testLeaderboard] –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞');
            
            if (!supabaseClient) {
                console.error('[testLeaderboard] Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }

            // –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
            console.log('[testLeaderboard] –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∑–∞–ø–∏—Å–∏');
            try {
                const testData = {
                    telegram_id: 999999999,
                    username: '–¢–µ—Å—Ç–æ–≤—ã–π –∏–≥—Ä–æ–∫',
                    max_score: 1000,
                    updated_at: new Date().toISOString()
                };
                
                const { data: insertData, error: insertError } = await supabaseClient
                    .from('leaderboard')
                    .upsert(testData, { onConflict: 'telegram_id' })
                    .select();
                
                if (insertError) {
                    console.error('[testLeaderboard] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –∑–∞–ø–∏—Å–∏:', insertError);
                } else {
                    console.log('[testLeaderboard] –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞:', insertData);
                }
            } catch (error) {
                console.error('[testLeaderboard] –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ 1:', error);
            }

            // –¢–µ—Å—Ç 2: –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
            console.log('[testLeaderboard] –¢–µ—Å—Ç 2: –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π');
            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .order('max_score', { ascending: false })
                    .limit(10);
                
                if (error) {
                    console.error('[testLeaderboard] –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏:', error);
                } else {
                    console.log('[testLeaderboard] –ü–æ–ª—É—á–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:', data ? data.length : 0);
                    console.log('[testLeaderboard] –î–∞–Ω–Ω—ã–µ:', data);
                }
            } catch (error) {
                console.error('[testLeaderboard] –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ 2:', error);
            }

            // –¢–µ—Å—Ç 3: –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π —Ç–æ–ø–æ–≤
            console.log('[testLeaderboard] –¢–µ—Å—Ç 3: –í—ã–∑–æ–≤ getLeaderboardTopRun() –∏ getLeaderboardTopTotal()');
            const topRun = await getLeaderboardTopRun();
            const topTotal = await getLeaderboardTopTotal();
            console.log('[testLeaderboard] –†–µ–∑—É–ª—å—Ç–∞—Ç getLeaderboardTopRun:', topRun);
            console.log('[testLeaderboard] –†–µ–∑—É–ª—å—Ç–∞—Ç getLeaderboardTopTotal:', topTotal);
        };

        let score = 0;            // total_score (–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è)
        let runScore = 0;          // —Å—á—ë—Ç —Ç–µ–∫—É—â–µ–≥–æ –∑–∞—Ö–æ–¥–∞ (—Å–µ—Å—Å–∏–∏)
        let saveTimeout = null;    // —Ç–∞–π–º–µ—Ä –¥–ª—è debounce

        let cat1Index = 0;

        let cat2Index = 0;

        const CELEBRATION_DURATION_MS = 6000; // –±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ; —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–µ—Ä—ë—Ç—Å—è –∏–∑ getCelebrationDurationMs()



        // –ú–∞—Å—Å–∏–≤—ã —Å —Ñ–æ—Ç–æ (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

        const cat1Photos = [

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2550.jpeg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2556.jpeg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2546.jpeg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2548.jpeg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2557.jpeg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_9_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_6_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_4_2025-11-10_17-01-48.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_3_2025-11-10_17-01-48.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_3_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_2_2025-11-10_17-01-48.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_2_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_23_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_22_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_1_2025-11-10_17-01-48.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_17_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_16_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_14_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/photo_11_2025-11-10_16-54-08.jpg"

        ];

        const cat2Photos = [

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2558.jpeg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2552.jpeg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2549.jpeg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2555.jpeg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/IMG_2547.jpeg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Rerks_6_2025-11-10_17-01-48.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_8_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_7_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_5_2025-11-10_17-01-48.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_5_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_4_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_24_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_21_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_1_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_19_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_18_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_15_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_13_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_12_2025-11-10_16-54-08.jpg",

            "https://raw.githubusercontent.com/jeremyelfo/KeshaKeks/refs/heads/main/Keks_10_2025-11-10_16-54-08.jpg"

        ];



        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞–º–∏ –¥–ª—è –∞—á–∏–≤–æ–∫ –∏ –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–π (–°–ö–û–†–†–ï–ö–¢–ò–†–û–í–ê–ù–û) ---



        // Fast math checks instead of huge precomputed arrays
        function isSuper(n) { return n > 0 && n % 1000 === 0; }
        function isMilestone(n) { return n >= 500 && (n - 500) % 1000 === 0; }
        function isEveryHundred(n) { return n > 0 && n % 100 === 0; }
        function isAchievement(n) { return n === 1 || n === 50 || (n % 100 === 0) || (n % 100 === 50); }
        const unlockedAchievements = new Set();

        const unlockedMilestones = new Set();

        const unlockedSupers = new Set();

        const achSlotMapping = { 
            100: '100',
            200: '200',
            500: '500',
            1000: '1k',
            2000: '2k',
            5000: '5k',
            10000: '10k', 
            20000: '20k', 
            50000: '50k', 
            100000: '100k', 
            500000: '500k', 
            1000000: '1m' 
        }; // –î–ª—è –≥—Ä–∏–¥–∞



        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---



        function createParticle(x, y, emoji = '‚ô•Ô∏è', color = '#ff69b4', container = document.body, duration = 1000, isCelebration = false) {

            const particle = document.createElement('div');

            particle.innerHTML = emoji;

            particle.className = 'heart';

            if (isCelebration) {

                particle.classList.add('celebration-particle');

            }



            particle.style.left = x + 'px';

            particle.style.top = y + 'px';

            particle.style.color = color;

            const light = getLightMode();
            const baseSize = light ? 18 : 24;
            particle.style.fontSize = (baseSize + Math.random() * (light ? 8 : 12)) + 'px';

            particle.style.pointerEvents = 'none';

            particle.style.zIndex = '100';



            const randX = (Math.random() - 0.5) * (isCelebration ? (getLightMode() ? 200 : 400) : 80);

            particle.style.setProperty('--rand-x', randX + 'px');



            const finalDuration = isCelebration ? duration : (getLightMode() ? 700 : 1000);

            particle.style.animation = `floatUp ${finalDuration / 1000}s ease-out forwards`;



            container.appendChild(particle);



            setTimeout(() => {

                particle.remove();

            }, finalDuration);

        }



        function launchSalute() {

            const light = getLightMode();
            const area = Math.min(1.0, (window.innerWidth * window.innerHeight) / (390*844)); // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫ iPhone 12 mini
            const numHearts = Math.max(8, Math.round((light ? 16 : 50) * area));

            for (let i = 0; i < numHearts; i++) {

                const x = Math.random() * window.innerWidth;

                const y = Math.random() * window.innerHeight;

                const dur = getCelebrationDurationMs();
                setTimeout(() => createParticle(x, y, '‚ô•Ô∏è', '#ff69b4', document.body, dur, true), i * (light ? 30 : 50));

            }

            if (tg.HapticFeedback && !getLightMode()) {
                tg.HapticFeedback.impactOccurred('medium');
            }

        }



        // MILESTONE: –ò–∑–º–µ–Ω–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è —Ñ–æ–Ω–∞ –Ω–∞ –±–æ–ª–µ–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ –º–∏–≥–∞–Ω–∏–µ

        function launchMilestone() {

            const light = getLightMode();
            const dur = getCelebrationDurationMs();
            if (tg.HapticFeedback && !light) {
                tg.HapticFeedback.impactOccurred('medium');
                setTimeout(() => tg.HapticFeedback.impactOccurred('light'), 200);
            }



            // 1. –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–æ–Ω–∞ –Ω–∞ 6 —Å–µ–∫—É–Ω–¥, –º–∏–≥–∞—é—â–∞—è —Å–∏–ª—å–Ω–µ–µ

            document.body.style.animation = `blink-strong ${light ? '1s' : '0.5s'} ease-in-out infinite`; 

            

            // 2. –í–∑—Ä—ã–≤ –ª–∞–ø–æ–∫ –∏ –∑–≤—ë–∑–¥–æ—á–µ–∫

            const centerX = window.innerWidth / 2;

            const centerY = window.innerHeight / 2;

            const numParticles = light ? 12 : 30;

            const emojis = ['üêæ', '‚≠ê', '‚ú®', 'üê±'];

            const colors = ['#ffd700', '#00ff00', '#ff00ff', '#ffff00'];

            for (let i = 0; i < numParticles; i++) {

                const emoji = emojis[Math.floor(Math.random() * emojis.length)];

                const color = colors[Math.floor(Math.random() * colors.length)];

                const delay = i * 30;

                setTimeout(() => {

                    const angle = (i / numParticles) * Math.PI * 2 + Math.random() * Math.PI/4;

                    const dist = 200 + Math.random() * 200;

                    const x = centerX + Math.cos(angle) * dist;

                    const y = centerY + Math.sin(angle) * dist;

                    createParticle(x, y, emoji, color, document.body, dur, true);

                }, delay);

            }

            

            // 3. –û—Ç–º–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ 6 —Å–µ–∫—É–Ω–¥

            setTimeout(() => {

                document.body.style.animation = '';

            }, dur);

        }



        // SUPER: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è, –±–æ–ª–µ–µ —Å–∏–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è flash-strong

        function launchSuperEffect(threshold) {

            if (unlockedSupers.has(threshold)) return;

            unlockedSupers.add(threshold);



            // 1. –ú–∞—Å—Å–æ–≤—ã–π —à—Ç–æ—Ä–º —ç–º–æ–¥–∑–∏ –ø–æ –≤—Å–µ–º—É —ç–∫—Ä–∞–Ω—É

            const light = getLightMode();
            const dur = getCelebrationDurationMs();
            const area = Math.min(1.2, (window.innerWidth * window.innerHeight) / (390*844));
            const numParticles = Math.max(16, Math.round((light ? 40 : 100) * area));

            const superEmojis = ['üòª', 'üéâ', '‚ú®', '‚≠ê', 'üêæ', 'üíñ', 'üåü', 'üéä'];

            const superColors = ['#ff69b4', '#ffd700', '#00ff00', '#ff00ff', '#ffff00', '#ff1493', '#00bfff', '#ff4500'];

            for (let i = 0; i < numParticles; i++) {

                const emoji = superEmojis[Math.floor(Math.random() * superEmojis.length)];

                const color = superColors[Math.floor(Math.random() * superColors.length)];

                const x = Math.random() * window.innerWidth;

                const y = Math.random() * window.innerHeight;

                const delay = i * (light ? 10 : 20);

                setTimeout(() => createParticle(x, y, emoji, color, document.body, dur, true), delay);

            }



            // 2. –°–∏–ª—å–Ω–æ–µ –º–∏–≥–∞–Ω–∏–µ –∫–æ—Ç–æ–≤ (6 —Å–µ–∫—É–Ω–¥)

            const cats = document.querySelectorAll('.cat');

            cats.forEach(cat => {

                cat.style.animation = `flash-strong ${light ? '0.6s' : '0.3s'} ease-in-out infinite`;

                setTimeout(() => cat.style.animation = '', dur);

            });

            

            // 3. –†–∞–¥—É–∂–Ω—ã–π —Ñ–ª–µ—à —Ñ–æ–Ω–∞ —Å –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ (6 —Å–µ–∫—É–Ω–¥)

            const originalBg = document.body.style.background;

            const flashes = [

                'linear-gradient(135deg, #ff69b4 0%, #ff1493 50%, #c71585 100%)',

                'linear-gradient(135deg, #ffd700 0%, #ffff00 50%, #ff4500 100%)',

                'linear-gradient(135deg, #00ff00 0%, #00bfff 50%, #0000ff 100%)',

                'linear-gradient(135deg, #ff00ff 0%, #8a2be2 50%, #4b0082 100%)'

            ];

            let flashIndex = 0;

            const flashInterval = setInterval(() => {

                document.body.style.background = flashes[flashIndex % flashes.length];

                flashIndex++;

            }, light ? 350 : 200);

            setTimeout(() => {

                clearInterval(flashInterval);

                document.body.style.background = originalBg;

            }, dur);



            // 4. –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è (light mode: —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è)

            if (tg.HapticFeedback && !light) {
                for (let v = 0; v < dur / 400; v++) {
                    setTimeout(() => tg.HapticFeedback.impactOccurred('light'), v * 400);
                }
            }



            // 5. –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–°–ö–û–†–†–ï–ö–¢–ò–†–û–í–ê–ù–û)

            const achText = document.getElementById('ach-text');

            achText.innerText = `${threshold} —Ç–∞–ø–æ–≤! üåàüí•`;

            const elem = document.getElementById('achievement');

            elem.classList.add('show');

            setTimeout(() => {

                elem.classList.remove('show');

            }, Math.max(1200, getCelebrationDurationMs() - 1200));

        }



        // Achievement: –£–±—Ä–∞–Ω–æ —Å–ª–æ–≤–æ "–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ:"

        function showAchievement(threshold) {

            if (tg.HapticFeedback) {

                tg.HapticFeedback.notificationOccurred('success');

            }



            const achText = document.getElementById('ach-text');

            achText.innerText = `${threshold} —Ç–∞–ø–æ–≤! üéâ`; // –£–±—Ä–∞–Ω–æ —Å–ª–æ–≤–æ "–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ:"

            const elem = document.getElementById('achievement');

            elem.classList.add('show');

            setTimeout(() => {

                elem.classList.remove('show');

            }, 3000);

            

            // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–ª–æ—Ç–∞ –≤ –≥—Ä–∏–¥–µ

            if (achSlotMapping[threshold]) {

                const slotId = `ach-slot-${achSlotMapping[threshold]}`;

                const slot = document.getElementById(slotId);

                if (slot) {

                    slot.classList.add('unlocked');

                    slot.onclick = () => alert(`–ê—á–∏–≤–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞: ${threshold} —Ç–∞–ø–æ–≤!`);

                }

            }

        }

        

        // showSpecialAchievement - –£–î–ê–õ–ï–ù–û



        function checkAchievement(newScore) {

            // 1. SUPER (–∫–∞–∂–¥–∞—è 1000)
            if (isSuper(newScore) && !unlockedSupers.has(newScore)) {
                launchSuperEffect(newScore);
            }
            // 2. MILESTONE (500, 1500, 2500...)
            else if (isMilestone(newScore) && !unlockedMilestones.has(newScore)) {
                unlockedMilestones.add(newScore);
                launchMilestone();
            }
            // 3. SALUTE (–∫–∞–∂–¥–∞—è —Å–æ—Ç–Ω—è, –∏—Å–∫–ª—é—á–∞—è –≤—ã—à–µ)
            else if (isEveryHundred(newScore) && !isMilestone(newScore) && !isSuper(newScore)) {
                launchSalute();
            }

            // 4. –û–±—ã—á–Ω–∞—è –∞—á–∏–≤–∫–∞ (1, 50, –∫–∞–∂–¥–∞—è 100 –∏ 100+50)
            if (isAchievement(newScore) && !unlockedAchievements.has(newScore)) {
                unlockedAchievements.add(newScore);
                showAchievement(newScore);
            }

            // 5. —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∞—á–∏–≤–∫–∏ ‚Äî —É–¥–∞–ª–µ–Ω–æ
        }



        function clickCat(catNumber, x, y) {

            if (inputLocked) return;
            
            // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Ç–∞–ø–µ –ø—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–≤—É–∫
            if (!audioInitialized) tryPlayAudio();

            score++;
            runScore++;

            document.getElementById('score').innerText = `–û—á–∫–∏ —É—é—Ç–∞: ${score}`;

            checkAchievement(score);

            // Debounced save: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ 500ms –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–ª–∏–∫–∞
            const user = tg.initDataUnsafe?.user;
            if (user && supabaseClient) {
                // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
                if (saveTimeout) clearTimeout(saveTimeout);
                
                // –°—Ç–∞–≤–∏–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä –Ω–∞ 500ms
                saveTimeout = setTimeout(() => {
                    debugLog(`Debounced save: score=${score}, runScore=${runScore}`);
                    updateScores(user.id, user.username || 'anon', runScore, score).catch(err => {
                        debugLog(`Save error: ${err.message}`);
                    });
                }, 500);
            }



            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–ª–∏–∫–∞ (–¥–ª—è –∫–Ω–æ–ø–∫–∏ - —ç—Ç–æ —Å–∞–º–∞ –∫–Ω–æ–ø–∫–∞, –¥–ª—è –∫–æ—Ç–∞ - –µ–≥–æ —Ü–µ–Ω—Ç—Ä)

            let finalX, finalY;

            if (catNumber === 1 || catNumber === 2) {

                const cat = document.getElementById('cat' + catNumber);

                const rect = cat.getBoundingClientRect();

                finalX = rect.left + rect.width / 2;

                finalY = rect.top + rect.height / 2;

            } else {

                finalX = x;

                finalY = y;

            }



            // –°–æ–∑–¥–∞—ë–º —Å–µ—Ä–¥–µ—á–∫–æ

            createParticle(finalX, finalY, '‚ô•Ô∏è', '#ff69b4');



            // –ú–µ–Ω—è–µ–º —Ñ–æ—Ç–æ, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–ø–Ω—É–ª–∏ –ø–æ –∫–æ—Ç—É, –∞ –Ω–µ –ø–æ –±–æ–ª—å—à–æ–π –∫–Ω–æ–ø–∫–µ

            if (catNumber === 1) {

                cat1Index = (cat1Index + 1) % cat1Photos.length;

                document.getElementById('cat1').src = cat1Photos[cat1Index];

            } else if (catNumber === 2) {

                cat2Index = (cat2Index + 1) % cat2Photos.length;

                document.getElementById('cat2').src = cat2Photos[cat2Index];

            }



            // –ê–≤—Ç–æ—Å–µ–π–≤ —Å—á—ë—Ç–∞

            tg.GameProxy.setGameScore({ score: score }, (data) => {

                if (data) {

                    // Score saved

                }

            });

        }






        function openModal() {
            try {
                const modal = document.getElementById('welcomeModal');
                if (!modal) {
                    console.warn('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    return;
                }
                modal.classList.add('show');
                modal.setAttribute('aria-hidden', 'false');
                document.body.classList.add('has-modal');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', error);
            }
        }



        function closeModal() {
            const modal = document.getElementById('welcomeModal');
            if (!modal) return;
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('has-modal');
            inputLocked = false;
            
            // –ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–≤—É–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
            tryPlayAudio();
        }

        function setFirstNameError(msg){ try{ document.getElementById('firstNameError').textContent = msg || ''; } catch(_){} }
        function isValidName(name){
            const n = (name||'').trim();
            // –†–∞–∑—Ä–µ—à–∞–µ–º –ª–∞—Ç–∏–Ω–∏—Ü—É/–∫–∏—Ä–∏–ª–ª–∏—Ü—É, —Ü–∏—Ñ—Ä—ã, _ –∏ - ; –¥–ª–∏–Ω–∞ 4‚Äì15
            return /^[A-Za-z–ê-–Ø–∞-—è–Å—ë0-9_-]{4,15}$/.test(n);
        }
        async function isNameTakenCI(name){
            try{
                const { data, error } = await supabaseClient
                  .from('leaderboard')
                  .select('username, telegram_id')
                  .ilike('username', name);
                if (error) { console.warn('[isNameTakenCI] error', error); return false; }
                const lower = name.toLocaleLowerCase();
                const rows = Array.isArray(data) ? data : [];
                return rows.some(r => (r.username||'').toLocaleLowerCase() === lower && r.telegram_id !== (tg.initDataUnsafe?.user?.id));
            }catch(e){ console.warn('[isNameTakenCI] catch', e); return false; }
        }
        function openFirstModal(){
            const m = document.getElementById('welcomeModalFirst');
            if (!m) return;
            m.classList.add('show');
            m.setAttribute('aria-hidden','false');
            document.body.classList.add('has-modal');
            const i = document.getElementById('firstNameInput');
            if (i) i.focus();
        }
        async function saveFirstTimeName(){
            try{
                const input = document.getElementById('firstNameInput');
                const val = (input?.value||'').trim();
                if (!isValidName(val)) { setFirstNameError('–î–æ–ø—É—Å—Ç–∏–º—ã –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã/_/-, 4‚Äì15 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
                setFirstNameError('');
                const user = tg.initDataUnsafe?.user;
                if (!user || !supabaseClient) { closeModal(); return; }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –Ω–∏–∫
                if (await isNameTakenCI(val)) { setFirstNameError('–ù–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç'); return; }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                setStoredDisplayName(val);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ Edge Function
                const initData = tg.initData || '';
                if (initData) {
                    try {
                        await supabaseClient.functions.invoke('update_scores', {
                            body: {
                                initData,
                                runScore: 0,
                                totalScore: 0,
                                displayName: val
                            }
                        });
                    } catch (e) {
                        console.warn('[saveFirstTimeName] Edge Function error', e);
                    }
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –≤—Ö–æ–¥–∏–º
                const m = document.getElementById('welcomeModalFirst');
                if (m) { m.classList.remove('show'); m.setAttribute('aria-hidden','true'); document.body.classList.remove('has-modal'); }
                inputLocked = false;
                
                // –ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–≤—É–∫ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
                tryPlayAudio();
            }catch(e){ setFirstNameError('–û—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑'); console.warn('[saveFirstTimeName]', e); }
        }
        // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–±–µ–∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏)
        async function loadServerProgress() {
            try {
                const user = tg.initDataUnsafe?.user;
                if (!user || !supabaseClient) {
                    // –§–æ–ª–±—ç–∫ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ—Ñ—Ñ–ª–∞–π–Ω/–Ω–µ—Ç Telegram
                    try {
                        const raw = localStorage.getItem('kk_current_score');
                        const s = raw ? parseInt(raw, 10) : 0;
                        if (!isNaN(s) && s > 0) score = s;
                    } catch (_) {}
                    const el = document.getElementById('score');
                    if (el) el.innerText = `–û—á–∫–∏ —É—é—Ç–∞: ${score}`;
                    return;
                }
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('total_score, max_score, username')
                    .eq('telegram_id', user.id)
                    .maybeSingle();
                if (error) { console.warn('[loadServerProgress] error', error); }
                const total = (data && typeof data.total_score === 'number') ? data.total_score : 0;
                score = total;
                runScore = 0;
                // –ï—Å–ª–∏ –≤ –ë–î –µ—Å—Ç—å username –∏ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∏–∫–Ω–µ–π–º, –ø–æ–¥—Ç—è–Ω–µ–º –µ–≥–æ –≤ localStorage,
                // —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–∏—Ä–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ç–µ–ª–µ–≥—Ä–∞–º-–Ω–∏–∫–æ–º –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö –∞–ø–¥–µ–π—Ç–∞—Ö
                try {
                    const localName = (getStoredDisplayName() || '').trim();
                    const dbName = (data && (data.username||'').trim()) || '';
                    if (!localName && dbName) setStoredDisplayName(dbName);
                } catch(_) {}
                const el = document.getElementById('score');
                if (el) el.innerText = `–û—á–∫–∏ —É—é—Ç–∞: ${score}`;
            } catch (e) { console.warn('[loadServerProgress] catch', e); }
        }
        function restoreAchievementGridFromScore() {
            try {
                const thresholds = Object.keys(achSlotMapping).map(k => parseInt(k, 10)).sort((a, b) => a - b);
                thresholds.forEach(th => {
                    if (score >= th) {
                        const slotId = `ach-slot-${achSlotMapping[th]}`;
                        const slot = document.getElementById(slotId);
                        if (slot) {
                            slot.classList.add('unlocked');
                            slot.onclick = () => alert(`–ê—á–∏–≤–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞: ${th} —Ç–∞–ø–æ–≤!`);
                        }
                        unlockedAchievements.add(th);
                    }
                });
            } catch (_) {}
        }

        function getCssVarPx(name, fallback) {
            try {
                const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
                if (!v) return fallback;
                if (v.endsWith('px')) return parseFloat(v);
                const n = parseFloat(v); return isNaN(n) ? fallback : n;
            } catch (_) { return fallback; }
        }

        // –ê—É–¥–∏–æ –º–µ–Ω–µ–¥–∂–µ—Ä —Å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é Autoplay Policy
        let audioContext = null;
        let audioInitialized = false;
        function tryPlayAudio() {
            const audio = document.getElementById('backgroundMusic');
            if (!audio || audioInitialized) return;
            
            audio.volume = 0.3;
            audio.play()
                .then(() => {
                    audioInitialized = true;
                    console.log('–ó–≤—É–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω');
                })
                .catch(err => {
                    console.log('–ó–≤—É–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º:', err);
                    // –ü–æ–ø—Ä–æ–±—É–µ–º Web Audio API –∫–∞–∫ —Ñ–æ–ª–±—ç–∫
                    tryWebAudioAPI();
                });
        }
        
        function tryWebAudioAPI() {
            if (audioContext || audioInitialized) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('Web Audio API –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                        // –ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ Web Audio –ø–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞—É–¥–∏–æ
                        const audio = document.getElementById('backgroundMusic');
                        if (audio) {
                            audio.play().then(() => {
                                audioInitialized = true;
                                console.log('–ó–≤—É–∫ –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ Web Audio API');
                            }).catch(() => console.log('–ó–≤—É–∫ –≤—Å—ë –µ—â—ë –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'));
                        }
                    });
                }
            } catch (err) {
                console.log('Web Audio API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:', err);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ Edge Function
        async function updateScores(telegramId, username, runVal, totalVal) {
            debugLog(`updateScores: run=${runVal} total=${totalVal}`);
            
            if (!supabaseClient) { 
                debugLog('ERROR: Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); 
                return; 
            }
            
            const storedName = (getStoredDisplayName() || '').trim();
            debugLog(`storedName: ${storedName}`);
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º initData –æ—Ç Telegram
                const initData = tg.initData || '';
                debugLog(`initData length: ${initData.length}`);
                
                if (!initData) {
                    debugLog('ERROR: –ù–µ—Ç Telegram initData');
                    return;
                }

                const payload = {
                    initData,
                    runScore: runVal,
                    totalScore: totalVal,
                    displayName: storedName
                };
                debugLog(`Sending to Edge Function...`);

                // –í—ã–∑—ã–≤–∞–µ–º Edge Function
                const { data, error } = await supabaseClient.functions.invoke('update_scores', {
                    body: payload
                });

                if (error) {
                    debugLog(`ERROR: ${error.message || error.name}`);
                    debugLog(`Error details: ${JSON.stringify(error)}`);
                    if (data) debugLog(`Response data: ${JSON.stringify(data)}`);
                } else {
                    debugLog(`SUCCESS: ${JSON.stringify(data)}`);
                }
            } catch (e) {
                debugLog(`EXCEPTION: ${e.message}`);
            }
        }
        async function decideWelcomeModal(){
            try{
                const user = tg.initDataUnsafe?.user;
                if (!user || !supabaseClient) { openModal(); return; }
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('username')
                    .eq('telegram_id', user.id)
                    .maybeSingle();
                const hasName = !!(data && (data.username||'').trim());
                if (!hasName && !(getStoredDisplayName()||'').trim()) openFirstModal(); else openModal();
            }catch(e){ openModal(); }
        }

        // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ë–û–õ–¨–®–û–ô –ö–†–£–ì–õ–û–ô –ö–ù–û–ü–ö–ò ---



        function handleTapZone(e) {

            if (inputLocked) { e.preventDefault(); return; }

            e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ


            let clientX;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–¥–ª—è —Ç–∞—á–∞ –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ø–∞–ª–µ—Ü, –¥–ª—è –∫–ª–∏–∫–∞ - mouseX)

            if (e.touches && e.touches.length > 0) {

                clientX = e.touches[0].clientX;

            } else if (e.clientX !== undefined) {

                clientX = e.clientX;

            } else {

                return; // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, –≤—ã—Ö–æ–¥–∏–º

            }



            const button = e.currentTarget;

            const rect = button.getBoundingClientRect();

            const center = rect.left + rect.width / 2;

            const tapX = clientX;

            const tapY = rect.top + rect.height / 2; // –¶–µ–Ω—Ç—Ä –∫–Ω–æ–ø–∫–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏

            // –≠—Ñ—Ñ–µ–∫—Ç—ã –∑–æ–Ω—ã —Ç–∞–ø–∞: –ª—ë–≥–∫–∏–π –Ω–∞–∫–ª–æ–Ω –≤ —Å—Ç–æ—Ä–æ–Ω—É —Ç–∞–ø–∞ (–±–µ–∑ –±–ª–∏–∫–∞)
            const tiltClass = (tapX < center) ? 'tap-tilt-left' : 'tap-tilt-right';
            button.classList.add(tiltClass);
            setTimeout(() => { button.classList.remove(tiltClass); }, 160);



            let catToClick;

            

            // –ï—Å–ª–∏ —Ç–∞–ø–Ω—É–ª–∏ –ø–æ –ª–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–º–µ–Ω—å—à–µ —Ü–µ–Ω—Ç—Ä–∞)

            if (tapX < center) {

                catToClick = 1; // –®–æ–∫–æ–ª–∞–¥–Ω—ã–π –∫–æ—Ç–∏–∫

            } 

            // –ï—Å–ª–∏ —Ç–∞–ø–Ω—É–ª–∏ –ø–æ –ø—Ä–∞–≤–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–±–æ–ª—å—à–µ —Ü–µ–Ω—Ç—Ä–∞)

            else {

                catToClick = 2; // –°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π –∫–æ—Ç–∏–∫

            }

            

            // –í—ã–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∫–ª–∏–∫–∞, –ø–µ—Ä–µ–¥–∞–≤–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–∞–ø–∞

            clickCat(catToClick, tapX, tapY);

        }




        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

        window.onload = function() {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
            // decideWelcomeModal —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ DOMContentLoaded –≤—ã—à–µ



            // –ë–æ–ª—å—à–µ –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–≤—É–∫ —Å—Ä–∞–∑—É ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

            

            // 1. –ö–æ—Ç–∏–∫–∏: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ touchstart/click –≤ —Ü–µ–Ω—Ç—Ä–µ

            const cat1 = document.getElementById('cat1');

            const cat2 = document.getElementById('cat2');

            

            if (cat1 && cat2) {
                // –î–ª—è –∫–æ—Ç–∏–∫–æ–≤ –æ—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–≤–æ–π–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è, –µ—Å–ª–∏ —Ç–∞–ø –ø–æ–ø–∞–¥–∞–µ—Ç —Å—Ä–∞–∑—É –Ω–∞ –∫–æ—Ç–∞ –∏ –Ω–∞ –∑–æ–Ω—É —Ç–∞–ø–∞.

                // –¢–µ–ø–µ—Ä—å –æ—Å–Ω–æ–≤–Ω–∞—è –∑–æ–Ω–∞ –∫–ª–∏–∫–∞ - tapZone. –ö–æ—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞

                cat1.addEventListener('touchstart', (e) => { 
                    e.preventDefault(); 
                    clickCat(1); 
                }, { passive: false });

                cat2.addEventListener('touchstart', (e) => { 
                    e.preventDefault(); 
                    clickCat(2); 
                }, { passive: false });

                cat1.addEventListener('click', () => clickCat(1));

                cat2.addEventListener('click', () => clickCat(2));
            } else {
                console.warn('–≠–ª–µ–º–µ–Ω—Ç—ã –∫–æ—Ç–∏–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            }



            // 2. –ë–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–∞–ø—ã/–∫–ª–∏–∫–∏ –¥–ª—è —Å–º–µ–Ω—ã —Ñ–æ—Ç–æ

            const tapZone = document.getElementById('tapZone');

            if (tapZone) {
                tapZone.addEventListener('touchstart', handleTapZone, { passive: false });

                tapZone.addEventListener('click', handleTapZone);
            } else {
                console.warn('–≠–ª–µ–º–µ–Ω—Ç tapZone –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }

            // 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
            const leaderboardModal = document.getElementById('leaderboardModal');
            if (leaderboardModal) {
                leaderboardModal.addEventListener('click', (e) => {
                    if (e.target.id === 'leaderboardModal') {
                        leaderboardModal.classList.remove('show');
                        leaderboardModal.setAttribute('aria-hidden', 'true');
                        document.body.classList.remove('has-modal');
                    }
                });
            }

            // 4. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            const finalSave = () => {
                const user = tg.initDataUnsafe?.user;
                if (user && supabaseClient && score > 0) {
                    debugLog(`[finalSave] score=${score}, runScore=${runScore}`);
                    // –û—Ç–º–µ–Ω—è–µ–º debounce —Ç–∞–π–º–µ—Ä
                    if (saveTimeout) {
                        clearTimeout(saveTimeout);
                        saveTimeout = null;
                    }
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                    updateScores(user.id, user.username || 'anon', runScore, score);
                }
            };

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    finalSave();
                }
            });

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—ã–≥—Ä—É–∑–∫–æ–π
            window.addEventListener('beforeunload', (e) => {
                finalSave();
                // –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ –Ω—É–∂–Ω–æ –∑–∞–¥–µ—Ä–∂–∞—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ
                e.returnValue = '';
            });
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
            window.addEventListener('blur', finalSave);

        };

    </script>

    <div id="footer" style="position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #b0b0b0; white-space: nowrap; z-index: 1;">Kesha and Keks (v0.3) powerd by Jeremy Elfo (c) 2025</div>



</body>

</html>
